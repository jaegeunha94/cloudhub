app  = "tickscript"
id = "learn-task"
template = """
{{ define "main"}}
// This script is generated by CloudHub application, Do not edit!
// If you edit this script for test, it will be overwritten in the next generation.

var name = '__AI Learn {{.OrgName}}__'

var db = '{{.OrgName}}'

var cron = '{{.LearningCron}}'

var loadModule = '{{.LoadModule}}'

var procCnt = '{{.ProcCnt}}'

var extra_opts = '{"organization":"{{.OrgID}}","influxdb":{"host":"{{.InfluxOrigin}}","port":{{.InfluxPort}},"username":"{{.InfluxUsername}}","password":"{{.InfluxPassword}}","db":"{{.OrgName}}"},"etcd":{"host":"{{.EtcdOrigin}}","port":"{{.EtcdPort}}"}}'

var data = batch
    |query('SELECT "cpu1min" FROM "{{.OrgName}}"."{{.RetentionPolicy}}"."snmp_nx"')
        .period(5m)
        .cron(cron)
    |count('cpu1min')
        .as('count')

data
    |alert()
        .crit(lambda: "count" > 0)
        .exec('/opt/cloudhub/bin/python', '/opt/cloudhub/ch-ai-src/ai.py', '-p', '/var/log/kapacitor-ai/ai.log', '-G', '-c', procCnt, '-M', loadModule, '-x', extra_opts)
{{ end }}
"""
