# ${org} : organization , ${hosts} : SNMP connection infomation by host
input {
	snmp {
		type => "snmp_collect"
		tags => ["${org}"]
        hosts=>["${hosts}"]
        interval => 60
        oid_root_skip => 6

		walk => [ "1.3.6.1.2.1.1.1",
			      "1.3.6.1.2.1.1.3",
		          "1.3.6.1.2.1.1.5" ]

		tables => [
			{
				"name" => "cpu"
				"columns" => [
					"1.3.6.1.4.1.9.9.109.1.1.1.1.6",	# 5sec
					"1.3.6.1.4.1.9.9.109.1.1.1.1.7"		# 1min
				]
			},

			{
				"name" => "memory"
				"columns" => [
					"1.3.6.1.4.1.9.9.48.1.1.1.5",	# used
					"1.3.6.1.4.1.9.9.48.1.1.1.6"	# free
				]
			},

			{
				"name" => "interfaces"
				"columns" => [
					"1.3.6.1.2.1.2.2.1.1",		# ifIndex
					"1.3.6.1.2.1.2.2.1.2",		# ifDescr
					"1.3.6.1.2.1.2.2.1.5",		# ifSpeed
					"1.3.6.1.2.1.2.2.1.6",		# ifPhysAddress
					"1.3.6.1.2.1.2.2.1.8",		# ifOperStatus
					"1.3.6.1.2.1.2.2.1.13",		# ifInDiscards
					"1.3.6.1.2.1.2.2.1.14",		# ifInErrors
					"1.3.6.1.2.1.2.2.1.19",		# ifOutDiscards
					"1.3.6.1.2.1.2.2.1.20",		# ifOutErrors
					"1.3.6.1.2.1.31.1.1.1.1",	# ifName
					"1.3.6.1.2.1.31.1.1.1.6",	# ifHCInOctets
					"1.3.6.1.2.1.31.1.1.1.7",	# ifHCInUcastPkts
					"1.3.6.1.2.1.31.1.1.1.8",	# ifHCInMulticastPkts
					"1.3.6.1.2.1.31.1.1.1.9",	# ifHCInBroadcastPkts
					"1.3.6.1.2.1.31.1.1.1.10",	# ifHCOutOctets
					"1.3.6.1.2.1.31.1.1.1.11",	# ifHCOutUcastPkts
					"1.3.6.1.2.1.31.1.1.1.12",	# ifHCOutMulticastPkts
					"1.3.6.1.2.1.31.1.1.1.13",	# ifHCOutBroadcastPkts
					"1.3.6.1.2.1.31.1.1.1.15",	# ifHighSpeed
					"1.3.6.1.2.1.31.1.1.1.18"	# ifAlias
				]
			},

			{
				"name" => "processes"
				"columns" => [
					"1.3.6.1.4.1.9.9.109.1.2.1.1.1", # pid
					"1.3.6.1.4.1.9.9.109.1.2.1.1.2", # name
					"1.3.6.1.4.1.9.9.109.1.2.3.1.3", # invoked
					"1.3.6.1.4.1.9.9.109.1.2.3.1.4", # runtime
					"1.3.6.1.4.1.9.9.109.1.2.3.1.5", # 5sec
					"1.3.6.1.4.1.9.9.109.1.2.3.1.6"  # 1min
				]
			}
		]
	}
}

output {
    if [type] == "snmp_collect" and "${org}" in [tags] {
        influxdb {
            host => "influxdb"
            port => 8086
            db => "${org}"
            measurement => "snmp_nx"
            data_points => {
                "agent_host" => "%{host}"
                "sys_name" => "%{sys_name}"
                "sys_desc" => "%{sys_desc}"
                "ifIndex" => "%{ifIndex}"
                "ifDescr" => "%{ifDescr}"
                "ifName" => "%{ifName}"
                "ifAlias" => "%{ifAlias}"
                "proc_name" => "%{proc_name}"
                "proc_id" => "%{proc_id}"
                "cpu5sec" => "%{cpu5sec}"
                "cpu1min" => "%{cpu1min}"
                "mem_use" => "%{mem_use}"
                "ifSpeed" => "%{ifSpeed}"
                "ifPhysAddress" => "%{ifPhysAddress}"
                "proc_cpu5s" => "%{proc_cpu5s}"
                "proc_cpu1m" => "%{proc_cpu1m}"
                "ifOperStatus" => "%{ifOperStatus}"
                "ifInDiscards" => "%{ifInDiscards}"
                "ifInErrors" => "%{ifInErrors}"
                "ifOutDiscards" => "%{ifOutDiscards}"
                "ifOutErrors" => "%{ifOutErrors}"
                "ifHCInOctets" => "%{ifHCInOctets}"
                "ifHCInUcastPkts" => "%{ifHCInUcastPkts}"
                "ifHCInMulticastPkts" => "%{ifHCInMulticastPkts}"
                "ifHCInBroadcastPkts" => "%{ifHCInBroadcastPkts}"
                "ifHCOutOctets" => "%{ifHCOutOctets}"
                "ifHCOutUcastPkts" => "%{ifHCOutUcastPkts}"
                "ifHCOutMulticastPkts" => "%{ifHCOutMulticastPkts}"
                "ifHCOutBroadcastPkts" => "%{ifHCOutBroadcastPkts}"
                "ifHighSpeed" => "%{ifHighSpeed}"
            }
			coerce_values => {
				"cpu5sec" => "float"
				"cpu1min" => "float"
				"mem_use" => "float"
				"ifSpeed" => "float"
				"proc_cpu5s" => "float"
				"proc_cpu1m" => "float"
				"ifInDiscards" => "float"
				"ifInErrors" => "float"
				"ifOutDiscards" => "float"
				"ifOutErrors" => "float"
				"ifHCInOctets" => "float"
				"ifHCInUcastPkts" => "float"
				"ifHCInMulticastPkts" => "float"
				"ifHCInBroadcastPkts" => "float"
				"ifHCOutOctets" => "float"
				"ifHCOutUcastPkts" => "float"
				"ifHCOutMulticastPkts" => "float"
				"ifHCOutBroadcastPkts" => "float"
				"ifHighSpeed" => "float"
			}
			send_as_tags => ["agent_host", "sys_name", "ifIndex", "ifDescr", "ifName", "ifAlias", "ifPhysAddress", "proc_name"]
        }
    }
}